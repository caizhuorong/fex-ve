function SSO_Controller(contorl_name,$){var login_method,is_IE,sso_auto_login,get_cookieinfo,create_iframe,create_form,login_by_iframe,login_by_script,register_by_iframe,logout_by_iframe,logout_by_script,excute_script,batch_excute_script,check_script_complete,get_domain,get_charset,add_input,del_input,remove_by_id,make_url,url_char,urlencode,urldecode,httpBuildQuery,parse_str,obj_merge,bind,me=this,update_cookie_timer=null,updaet_cookie_time_hard_limit=1800,cookie_expire_time_length=86400,jQuery=$?$:window.jQuery;this.name=contorl_name?contorl_name:"VE_SSO_Controller",this.sso_domain="veryeast.cn",this.domain="",this.is_set_domain=!0,this.cookieinfo="",this.login_status=!1,this.is_create_frame_onload=!0,this.sso_frame_name="sso_frame",this.login_form_id="sso_login_form",this.script_id="sso_script",this.login_request={},this.is_create_login_form=!1,this.register_form_id="sso_register_form",this.register_request={},this.is_create_register_form=!1,this.default_logout_type="iframe",this.logout_form_id="sso_logout_form",this.encoding="gb2312",this.sso_register_url="http://sso.veryeast.cn/user/register",this.check_field_url="http://sso.veryeast.cn/user/check_field",this.sso_login_url="http://sso.veryeast.cn/user/login",this.sso_logout_url="http://sso.veryeast.cn/user/logout",this.sso_ticket_url="http://sso.veryeast.cn/user/ticket",this.sso_ticket_api_url="http://sso.veryeast.cn/http_api/ticket",login_method="",is_IE=!!window.ActiveXObject,this.is_check_login_state=!0,this.is_update_cookie_onload=!0,this.init=function(a){"object"!=typeof a&&(a={}),me.encoding=get_charset(me.encoding);var b;for(b in a)me[b]=a[b];me.is_set_domain&&(document.domain=me.domain?me.domain:get_domain()),me.is_create_frame_onload&&jQuery(function(){create_iframe(me.sso_frame_name)}),me.is_update_cookie_onload,me.is_check_login_state&&jQuery(function(){me.check_login_state(me.login_state_callback)}),me.cookieinfo=get_cookieinfo(),me.custom_init()},this.register=function(a,b){a&&"object"==typeof a&&(me.register_request=obj_merge(me.register_request,a)),"function"==typeof b&&(me.register_callback=b),me.is_create_frame_onload?register_by_iframe():(create_iframe(me.sso_frame_name),setTimeout(register_by_iframe,30))},this.register_callback=function(){},this.login=function(a,b,c){switch(a&&"object"==typeof a&&(me.login_request=obj_merge(me.login_request,a)),"function"==typeof b&&(me.custom_login_callback=b),"undefined"==typeof c?c="iframe":"",c){case"script":login_by_script();break;case"iframe":default:me.is_create_frame_onload?login_by_iframe():(create_iframe(me.sso_frame_name),setTimeout(login_by_iframe,30))}},this.login_callback=function(a){me.login_status=!0;var b=a;"object"==typeof a&&"object"==typeof a.sso_scripts?batch_excute_script(a.sso_scripts,function(){me.custom_login_callback(b)}):me.custom_login_callback(a)},this.custom_login_callback=function(){},this.logout=function(a,b){var c,d,e;switch("undefined"==typeof a&&(a=me.default_logout_type),a){case"iframe":"function"==typeof b&&(me.custom_logout_callback=b),me.is_create_frame_onload?logout_by_iframe():(create_iframe(me.sso_frame_name),setTimeout(logout_by_iframe,30));break;case"script":"function"==typeof b&&(me.custom_logout_callback=b),logout_by_script();break;case"link":default:c="string"==typeof b?b:window.location.href,d={redirect:c,return_type:"link"},e=make_url(me.sso_logout_url,d),window.location.href=e}},this.logout_callback=function(a){me.login_status=!1;var b=a;"object"==typeof a&&"object"==typeof a.sso_scripts?batch_excute_script(a.sso_scripts,function(){me.custom_logout_callback(b),me.login_state_callback()}):(me.custom_logout_callback(a),me.login_state_callback())},this.custom_logout_callback=function(){return!0},this.excute_sso_method=function(a,b,c){b="undefined"==typeof b?{}:b,b=obj_merge(b,{method:a}),me.get_json(me.sso_ticket_api_url,b,c)},this.custom_init=function(){},this.check_field=function(a,b){return me.get_json(me.check_field_url,a,b)},this.get_json=function(a,b,c){"function"!=typeof c&&(c=function(a){return a});var d={return_type:"callback_json",encoding:"utf-8",callback_name:"callback"};b=b?obj_merge(d,b):d,jQuery.getJSON(a+url_char(a)+b.callback_name+"=?",b,c)},this.check_login_state=function(a){var b;return b=get_cookieinfo(),me.domain==me.sso_domain||"undefined"!=typeof b&&null!==b?(a(b),void 0):(sso_auto_login(a),!0)},this.login_state_callback=function(a){a&&(me.login_status=!0),me.custom_login_state_callback(a)},this.custom_login_state_callback=function(){},sso_auto_login=function(){var b={action:"get_cookie",return_type:"SCRIPT",callback:me.name+".login_state_callback"},c=me.sso_ticket_url;return c=make_url(c,b),excute_script(me.script_id,c,me.page_charset),!0},get_cookieinfo=function(){var a,b=me.getCookie("ticket"),c=me.getCookie("username"),d=me.getCookie("user_type");return null!==b&&null!==c&&(a={ticket:b,username:c,user_type:d}),a},create_iframe=function(a,b){null==b&&(b="javascript:void((function(){var d=document;d.open();d.domain='"+document.domain+"';d.write('');d.close()})())"),remove_by_id(a);var c=document.createElement("iframe");return c.height=0,c.width=0,c.style.display="none",c.name=a,c.id=a,c.src=b,jQuery(document.body).append(c),window.frames[a].name=a,c},create_form=function(a,b){null==b&&(b="none"),remove_by_id(a);var c=document.createElement("form");return c.height=0,c.width=0,c.style.display=b,c.name=a,c.id=a,jQuery(document.body).append(c),document.forms[a].name=a,c},login_by_iframe=function(){var a,b,c,d;document.getElementById(me.login_form_id)||(create_form(me.login_form_id),me.is_create_login_form=!0),a=jQuery("#"+me.login_form_id),b={return_type:"IFRAME",encoding:me.encoding,callback:"parent."+me.name+".login_callback"},b=obj_merge(b,me.login_request);for(c in b)add_input(a,c,b[c],"hidden");a.attr("target",me.sso_frame_name),a.attr("method","post"),a.attr("action",me.sso_login_url),d=!0;try{a.submit()}catch(e){d=!1}if(me.is_create_login_form)remove_by_id(me.login_form_id);else for(c in b)del_input(c,"hidden");return d},login_by_script=function(){var a={return_type:"SCRIPT",encoding:"utf-8",callback:me.name+".login_callback"};a=obj_merge(a,me.login_request),url=make_url(me.sso_login_url,a),excute_script(me.script_id,url,me.page_charset)},register_by_iframe=function(){var a,b,c,d;document.getElementById(me.register_form_id)||(create_form(me.register_form_id),me.is_create_register_form=!0),a=jQuery("#"+me.register_form_id),b={return_type:"IFRAME",encoding:me.encoding,register_page_source:document.referrer,callback:"parent."+me.name+".register_callback"},b=obj_merge(b,me.register_request);for(c in b)add_input(a,c,b[c],"hidden");a.attr("target",me.sso_frame_name),a.attr("method","post"),a.attr("action",me.sso_register_url),d=!0;try{a.submit()}catch(e){d=!1}if(me.is_create_register_form)remove_by_id(me.register_form_id);else for(c in b)del_input(c,"hidden");return d},logout_by_iframe=function(){var a,b,c;document.getElementById(me.logout_form_id)||create_form(me.logout_form_id),a=jQuery("#"+me.logout_form_id),b={return_type:"IFRAME",callback:"parent."+me.name+".logout_callback"};for(c in b)add_input(a,c,b[c],"hidden");a.attr("target",me.sso_frame_name),a.attr("method","get"),a.attr("action",me.sso_logout_url),a.submit(),remove_by_id(me.logout_form_id)},logout_by_script=function(){var a={return_type:"SCRIPT",callback:me.name+".logout_callback"};url=make_url(me.sso_logout_url,a),excute_script(me.script_id,url,me.page_charset)},excute_script=function(a,b,c,d){var e,f;remove_by_id(a),e=document.getElementsByTagName("head")[0],f=document.createElement("script"),f.charset=c||"utf-8",f.id=a,f.type="text/javascript",f.src=make_url(b,{_:(new Date).getTime()}),e.appendChild(f),"function"==typeof d&&(f.onload=f.onreadystatechange=function(){this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||d(a)})},batch_excute_script=function(a,b){var c,d;if("object"==typeof a){d={};for(c in a)"string"==typeof a[c]&&(d[me.script_id+"_"+c]=0,excute_script(me.script_id+"_"+c,a[c],me.page_charset,function(a){null!=d&&(d[a]=1),check_script_complete(d)&&(d=null,b())}))}},check_script_complete=function(a){if("object"==typeof a){for(var b in a)if(!a[b])return!1;return!0}},this.getCookie=function(name){var Res=eval("/;\\s+"+name+"=([^;]+)/").exec(document.cookie);return null==Res&&(Res=eval("/^\\s*"+name+"=([^;]+)/").exec(document.cookie)),null==Res?null:decodeURIComponent(Res[1])},this.get_GET=function(a){var e,f,g,h,b=new Object,c=location.search.substring(1),d=c.split("&");for(e=0;e<d.length;e++)f=d[e].indexOf("="),-1!=f&&(g=d[e].substring(0,f),g=g.toLocaleLowerCase(),h=d[e].substring(f+1),h=decodeURIComponent(h),b[g]=h);return"undefined"==typeof a?b:"undefined"==typeof b[a]?"":b[a]},get_domain=function(){var a,b=document.domain;return a=b.substring(b.search(/[^\.]+\.[^\.]+$/),b.length)},get_charset=function(a){var b=document.documentElement.innerHTML.match(/<meta.*charset=([^\"\']+).*?>/i);return b&&"undefined"!=typeof b[1]?b[1]:a},add_input=function(a,b,c,d){null==d&&(d="text");var e='<input type="'+d+'" name="'+b+'" id="'+b+'" value="'+c+'"/>';a.append(e)},del_input=function(a,b){null==b&&(b="text"),jQuery("input:"+b+"[name='"+a+"']").remove()},remove_by_id=function(a){try{"string"==typeof a&&(a=jQuery("#"+a)),a.remove()}catch(b){}},make_url=function(a,b){return a+url_char(a)+httpBuildQuery(b)},url_char=function(a){return/\?/.test(a)?"&":"?"},urlencode=function(a){return encodeURIComponent(a)},urldecode=function(a){if(void 0==a)return"";var b=decodeURIComponent(a);return"null"==b?"":b},httpBuildQuery=function(a){var b,c;if("object"!=typeof a)return"";b=new Array;for(c in a)"function"!=typeof a[c]&&b.push(c+"="+urlencode(a[c]));return b.join("&")},parse_str=function(a){var c,e,b=a.split("&"),d={};for(e=0;e<b.length;e++)c=b[e].split("="),d[c[0]]=urldecode(c[1]);return d},obj_merge=function(a,b){for(var c in b)a[c]=b[c];return a},bind=function(a,b,c){a.bind(b,c)}}module.exports=SSO_Controller;